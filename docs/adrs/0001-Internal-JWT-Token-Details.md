# 01. Internal JWT Token Details

Date: 2018-03-07

## Status

Accepted

## Context

In order to achieve Single sign on process among the Digital Business Platform we need to have a common authentication process between Alfresco Process Service and Alfresco Content Service.

An internal [JWT](https://jwt.io/introduction) bearer token generated by Keycloak will be consumed by both Alfresco Content Service and Alfresco Process Service.

We need to define the format of the payload of that internal JWT token.

## Decision

We will adopt standard Keycloak's OpenID Connect JWT format.

The user claim payload may contain the standard information as per the link below.
https://openid.net/specs/openid-connect-core-1_0.html#StandardClaims

Beside the above fields, we will also add to the mapper custom fields about group information for future use cases.

The example below shows an encoded JWT:
```
eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJ0ZE5mMWhDMzlDLW16dXdTLV9hcjF4MGJXYnVTRWxNd25TRGRDZUJPQW1jIn0.eyJqdGkiOiJkZDVlMDYyZC04MzlmLTQwNmEtOTJlMS1hMDlhYzFjY2NiMTciLCJleHAiOjE1MjEwMjI0NzQsIm5iZiI6MCwiaWF0IjoxNTIxMDIyMTc0LCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgxODAvYXV0aC9yZWFsbXMvYWxmcmVzY28iLCJhdWQiOiJhbGZyZXNjbyIsInN1YiI6Ijc4NGNhMDI2LWNmYWEtNDIyYy04OGU4LWI3NTY1NTE1ZmY3MSIsInR5cCI6IkJlYXJlciIsImF6cCI6ImFsZnJlc2NvIiwiYXV0aF90aW1lIjowLCJzZXNzaW9uX3N0YXRlIjoiZGI2ZTk0NDctMjJhZi00ZjJlLTllZTEtMTRhNWM1OTVhMzg4IiwiYWNyIjoiMSIsImFsbG93ZWQtb3JpZ2lucyI6WyIiXSwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbInVtYV9hdXRob3JpemF0aW9uIiwidXNlciJdfSwicmVzb3VyY2VfYWNjZXNzIjp7ImFjY291bnQiOnsicm9sZXMiOlsibWFuYWdlLWFjY291bnQiLCJtYW5hZ2UtYWNjb3VudC1saW5rcyIsInZpZXctcHJvZmlsZSJdfX0sIm5hbWUiOiJocnVzZXIgciIsInByZWZlcnJlZF91c2VybmFtZSI6ImhydXNlciIsImdpdmVuX25hbWUiOiJocnVzZXIiLCJmYW1pbHlfbmFtZSI6InIiLCJlbWFpbCI6ImhyQHRlc3QuY29tIn0.JBm33o07oD13mVNGB5FNdmMnWpAhWSaReGbLP88oj6LoLHf6DiuGGtmwuYP2qoRi-M4yBYLEqXMdDZ97_or8RbJXTfCZVX4AuUHa0J_P8AhEwu9Q3rxl7jV8RvUIqMe7IFl2Y5FVF8Tb1sxBS_WY4JBU2AM1d9mzf0E-_m29OxqIfdh3tgvQ4cCBVUtlzm8ilvAVdXPUxNvtIlNDVwFSPEyDDxAFHJ-7GCed8uOLlZhxGgpeuIQ4jn2VplxCatwIcbnArwLJe8XKfb2P4oVWJCWpvj_rFwtyUftLv2sPpyKZEgUTStxsn9Wgu8Iki-_ne43HKZGqBqlrMYrGAVoj9Q
```

The JWT above when decoded produces the following JSON:

HEADER:
```json
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "tdNf1hC39C-mzuwS-_ar1x0bWbuSElMwnSDdCeBOAmc"
}
```
PAYLOAD:
```json
{
  "jti": "dd5e062d-839f-406a-92e1-a09ac1cccb17",
  "exp": 1521022474,
  "nbf": 0,
  "iat": 1521022174,
  "iss": "http://localhost:8180/auth/realms/alfresco",
  "aud": "alfresco",
  "sub": "784ca026-cfaa-422c-88e8-b7565515ff71",
  "typ": "Bearer",
  "azp": "alfresco",
  "auth_time": 0,
  "session_state": "db6e9447-22af-4f2e-9ee1-14a5c595a388",
  "acr": "1",
  "allowed-origins": [
    ""
  ],
  "realm_access": {
    "roles": [
      "uma_authorization",
      "user"
    ]
  },
  "resource_access": {
    "account": {
      "roles": [
        "manage-account",
        "manage-account-links",
        "view-profile"
      ]
    }
  },
  "name": "hruser r",
  "preferred_username": "hruser",
  "given_name": "hruser",
  "family_name": "r",
  "email": "hr@test.com"
}
```

### Unique User ID

For common identity across the Alfresco platform, the combination of the issuer (`iss`) and subject (`sub`) should generally be considered the unchanging unique identifier for a user (as stated by [section 2 of the OpenID Connect Core 1.0 specification](http://openid.net/specs/openid-connect-core-1_0.html#IDToken)).

Note that the issuer is a URL, which may change after an initial deployment in an organization, so our common identity work should include the ability for an organization to change their issuer URL.  Alternatively, we could at that time choose to loosen adherence to the specification and declare that only the subject is required for a unique user ID within the platform.

Until components are updated to handle common identity they may chose to rely on the `preferred_username` or `email` claims.

## Consequences

Since the format is essentially predetermined by standards and Keycloak, we may find that certain aspects aren't exactly what we'd prefer and there may be some libraries that expect slightly different formats.

A positive consequence is that we're able to use the Keycloak client libraries with no change.
