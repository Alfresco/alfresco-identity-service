language: java
jdk:
  - openjdk11

# sudo: required

os: linux
dist: xenial

services:
  - docker

stages:
  - name: Test Windows
  - name: Lint
  - name: Build
  - name: Test
  - name: Publish
    if: branch = master OR commit_message = "[publish]"

# import:
#   - source: Alfresco/alfresco-process-tools:.travis.kubernetes_install.yml@master
#   - source: Alfresco/alfresco-process-tools:.travis.docker_login.yml@master

env:
  global:
    - TRAVIS_WAIT_TIMEOUT=${TRAVIS_WAIT_TIMEOUT:-30}
    - BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-${TRAVIS_BRANCH}}
    - HELM_REPO_BASE_URL=https://kubernetes-charts.alfresco.com
    - HELM_REPO=incubator
    - KUBERNETES_VERSION=1.18.4
    - HELM_VERSION=${HELM_VERSION:-3.2.4}

cache:
  directories:
    - ${HOME}/.m2
    - ${HOME}/.m2/repository

branches:
  only:
    - master
    - /AUTH-.*/
    - /OPSEXP-.*/


jobs:
  include:
    - name: Lint chart
      stage: Lint
      script: |
        helm dep up helm/${PROJECT_NAME}
        helm lint helm/${PROJECT_NAME}
    - name: Build
      stage: Build
      script: |
        cd distribution
        # build and package
        make || { echo "Command failed with error code $?"; sleep 1; exit 1; }
        # security scan the build
        source build.properties
        # curl -sSL https://srcclr.com/install | sh
        # make SCAN_FOLDER=alfresco-identity-service-${IDENTITY_VERSION} scan
        # upload ZIP file to S3 bucket
        aws s3 cp alfresco-identity-service-${IDENTITY_VERSION}.zip s3://${S3_ARTIFACTS_BUCKET}/build-${TRAVIS_BUILD_NUMBER}/
    - name: Test ZIP on Linux
      stage: Test
      script: |
        source distribution/build.properties
        export IDENTITY_VERSION=${IDENTITY_VERSION}
        echo "IDENTITY_VERSION=${IDENTITY_VERSION}"
        aws s3 cp s3://${S3_ARTIFACTS_BUCKET}/build-${TRAVIS_BUILD_NUMBER}/alfresco-identity-service-${IDENTITY_VERSION}.zip .
        chmod +x distribution/tests/endpoints.sh
        distribution/tests/endpoints.sh
      after_script: |
        # empty the artifacts bucket (in case there were previous failed builds)
        aws s3 rm s3://${S3_ARTIFACTS_BUCKET}/build-${TRAVIS_BUILD_NUMBER}/ --recursive
    - name: Test Windows
      stage: Test Windows
      os: windows
      language: shell
      env: OS=Windows
      powershell: |
        powershell -Command Add-Type -AssemblyName System.IO.Compression.FileSystem
        powershell -Command function unzip { param( [string]$ziparchive, [string]$extractpath ); [System.IO.Compression.ZipFile]::ExtractToDirectory( $ziparchive, $extractpath )}
        powershell -Command IDENTITY_VERSION=${IDENTITY_VERSION}
        powershell -Command aws s3 cp s3://${S3_ARTIFACTS_BUCKET}/build-${TRAVIS_BUILD_NUMBER}/alfresco-identity-service-${IDENTITY_VERSION}.zip .
        powershell -Command unzip '${bamboo.build.working.directory}\alfresco-identity-service-${bamboo.prop.IDENTITY_VERSION}.zip' '${bamboo.build.working.directory}'
        powershell -Command distribution/tests/endpoints_ps.ps1
    #     echo "TODO"
    # - name: Test Helm Chart
    #   stage: Test
    #   script: |
    #     echo "TODO"